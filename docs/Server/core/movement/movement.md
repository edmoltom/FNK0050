# Movimiento (`Server/core/movement`)

El subsistema de movimiento encapsula toda la lógica de locomoción, control de postura y animaciones. La fachada pública es `MovementControl`, que encola comandos de alto nivel y delega su ejecución en `MovementController`.​:codex-file-citation[codex-file-citation]{line_range_start=22 line_range_end=157 path=Server/core/MovementControl.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/MovementControl.py#L22-L157"}​

## Mapa de módulos

| Archivo | Responsabilidad |
| --- | --- |
| `MovementControl.py` | Fachada sencilla con métodos como `walk`, `step`, `turn`, control de cabeza y utilidades para ajustar velocidad o lanzar el bucle principal. Internamente encola dataclasses de comando sobre la cola del controlador.​:codex-file-citation[codex-file-citation]{line_range_start=22 line_range_end=157 path=Server/core/MovementControl.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/MovementControl.py#L22-L157"}​ |
| `movement/controller.py` | Núcleo que consume los comandos, actualiza el estado de las patas, convierte coordenadas en ángulos y envía los resultados al hardware. Gestiona el generador de marcha, las transiciones de estado, el control de cabeza, la cola de gestos y el bucle de `tick`/`start_loop`.​:codex-file-citation[codex-file-citation]{line_range_start=31 line_range_end=512 path=Server/core/movement/controller.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/movement/controller.py#L31-L512"}​ |
| `movement/hardware.py` | Agrupa los dispositivos de actuación (PCA9685, servos y CPG), carga la calibración de `calibration/point.txt` y aplica offsets antes de escribir en los servos.​:codex-file-citation[codex-file-citation]{line_range_start=32 line_range_end=118 path=Server/core/movement/hardware.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/movement/hardware.py#L32-L118"}​ |
| `movement/gait_runner.py` y `movement/gait_cpg.py` | Implementan el generador de patrones centrales (CPG) y las rutinas que traducen la fase del CPG a posiciones XYZ de cada pata, incluyendo giros, pasos laterales y paradas suaves.​:codex-file-citation[codex-file-citation]{line_range_start=10 line_range_end=167 path=Server/core/movement/gait_runner.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/movement/gait_runner.py#L10-L167"}​​:codex-file-citation[codex-file-citation]{line_range_start=7 line_range_end=81 path=Server/core/movement/gait_cpg.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/movement/gait_cpg.py#L7-L81"}​ |
| `movement/gestures.py` | Define la estructura de `Sequence`/`Keyframe` y un `GesturePlayer` que interpola keyframes, admite overrides de servos y puede cargar gestos desde JSON para reproducir animaciones no locomotoras.​:codex-file-citation[codex-file-citation]{line_range_start=11 line_range_end=200 path=Server/core/movement/gestures.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/movement/gestures.py#L11-L200"}​ |

## Flujo de control

1. `MovementControl` crea un `MovementController` con la configuración opcional de hardware y parámetros de actuación.​:codex-file-citation[codex-file-citation]{line_range_start=22 line_range_end=38 path=Server/core/MovementControl.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/MovementControl.py#L22-L38"}​
2. Cada llamada (`walk`, `step`, `turn`, `gesture`, etc.) encola un objeto de comando; el controlador drena la cola en cada `tick`.​:codex-file-citation[codex-file-citation]{line_range_start=40 line_range_end=119 path=Server/core/MovementControl.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/MovementControl.py#L40-L119"}​​:codex-file-citation[codex-file-citation]{line_range_start=395 line_range_end=512 path=Server/core/movement/controller.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/movement/controller.py#L395-L512"}​
3. `MovementController` mantiene el estado cinemático (matrices `point` y `angle`), valida límites y, si el punto es alcanzable, convierte a ángulos mediante `kinematics.coordinate_to_angle` antes de invocar `Hardware.apply_angles`.​:codex-file-citation[codex-file-citation]{line_range_start=163 line_range_end=223 path=Server/core/movement/controller.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/movement/controller.py#L163-L223"}​
4. El generador `GaitRunner` actualiza las patas según la fase del CPG en función de la velocidad/rotación actual o del comando discreto (`StepCmd`, `TurnCmd`).​:codex-file-citation[codex-file-citation]{line_range_start=400 line_range_end=512 path=Server/core/movement/controller.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/movement/controller.py#L400-L512"}​​:codex-file-citation[codex-file-citation]{line_range_start=10 line_range_end=167 path=Server/core/movement/gait_runner.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/movement/gait_runner.py#L10-L167"}​
5. Los gestos desactivan temporalmente el gait, insertan un keyframe inicial con la postura actual y delegan la reproducción en `GesturePlayer`.​:codex-file-citation[codex-file-citation]{line_range_start=363 line_range_end=393 path=Server/core/movement/controller.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/movement/controller.py#L363-L393"}​​:codex-file-citation[codex-file-citation]{line_range_start=69 line_range_end=170 path=Server/core/movement/gestures.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/movement/gestures.py#L69-L170"}​

## Calibración y hardware

- `Hardware` crea o reutiliza los controladores de servo, calcula offsets de calibración y aplica ángulos acotados en función del mapa de canales PCA9685.​:codex-file-citation[codex-file-citation]{line_range_start=32 line_range_end=118 path=Server/core/movement/hardware.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/movement/hardware.py#L32-L118"}​
- Los scripts de calibración y gestos se apoyan en `movement/data.py` (carga/guardado de matrices) y la carpeta `movement/gestures/` (JSON con keyframes), consumidos por `load_sequence_json`.​:codex-file-citation[codex-file-citation]{line_range_start=174 line_range_end=200 path=Server/core/movement/gestures.py git_url="https://github.com/edmoltom/FNK0050/blob/dev/Server/core/movement/gestures.py#L174-L200"}​

